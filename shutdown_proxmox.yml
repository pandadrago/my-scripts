---
  - name: Gracefully shut down VMs and Proxmox host
    hosts: proxmox
    become: yes  # Assuming sudo privileges are needed for some tasks
    gather_facts: no
  
    tasks:
      - name: Get the list of VMs on the Proxmox host
        shell: "qm list | awk '{print $1}' | tail -n +2"
        register: vm_list
        changed_when: false
  
      - name: Gracefully shut down all VMs
        shell: "qm shutdown {{ item }}"
        loop: "{{ vm_list.stdout_lines }}"
        when: vm_list.stdout != ''
      
      - name: Count number of VMs in vm_list
        set_fact:
          vm_count: "{{ vm_list | length }}"
  
      - name: Wait for VMs to shut down
        pause:
          minutes: "{{ vm_count }}"
        when: vm_list.stdout != '[]'
  
      - name: Shut down the Proxmox host
        command: "shutdown -h now"
        async: 1  # Run the command asynchronously
        poll: 0  # Don't wait for the task to finish (allow Ansible to finish before host shuts down)
        when: vm_list.stdout != '[]'
        ignore_errors: yes
  